---

- name: jinga templates
  block:
    - name: install profile
      loop:
        - .profile
        - .zprofile
      file:
        path: '{{ ansible_env.HOME }}/{{ item }}'
        state: absent

    - name: install env
      loop:
        - .zshenv
      ansible.builtin.blockinfile:
        marker: "# {mark} ANSIBLE MANAGED BLOCK devtainer profile"
        path: '{{ ansible_env.HOME }}/{{ item }}'
        create: true
        block: "{{ lookup('template', 'templates/env.sh.j2') }}"

    - name: standard renderings
      loop:
        - source: templates/gitconfig.j2
          dest: .gitconfig
      ansible.builtin.blockinfile:
        marker: "# {mark} ANSIBLE MANAGED BLOCK devtainer profile"
        path: '{{ ansible_env.HOME }}/{{ item.dest }}'
        create: true
        block: "{{ lookup('template', item.source) }}"

    - name: k9s hotkeys
      loop:
        - source: templates/k9s.yaml.j2
          dest: Library/Application Support/k9s/config.yaml
      ansible.builtin.blockinfile:
        marker: "# {mark} ANSIBLE MANAGED BLOCK devtainer profile"
        path: '{{ ansible_env.HOME }}/{{ item.dest }}'
        create: true
        block: "{{ lookup('template', item.source) }}"

    - name: homepage
      loop:
        - source: templates/homepage.yaml
          dest: .config/StartTree/config.yaml
      ansible.builtin.blockinfile:
        marker: "# {mark} ANSIBLE MANAGED BLOCK devtainer profile"
        path: '{{ ansible_env.HOME }}/{{ item.dest }}'
        create: true
        block: "{{ lookup('template', item.source) }}"

    # Cursor MCP Configuration
    - name: Check if argocd CLI is available
      ansible.builtin.command: which argocd
      register: argocd_cli_check
      failed_when: false
      changed_when: false
      when: argocd_mcp_issue_token_enabled | default(false)

    - name: Debug - ArgoCD CLI check result
      ansible.builtin.debug:
        msg: "ArgoCD CLI check: rc={{ argocd_cli_check.rc | default('skipped') }}, found={{ argocd_cli_check.stdout | default('not found') }}"
      when: argocd_mcp_issue_token_enabled | default(false)

    - name: Generate ArgoCD API token if enabled
      block:
        - name: Generate ArgoCD API token
          ansible.builtin.shell: |
            argocd account generate-token --account admin --server {{ argocd_mcp_url | regex_replace('^https?://', '') }}
          register: generated_token
          changed_when: false
          failed_when: false
          when: argocd_mcp_api_token is not defined or argocd_mcp_api_token == 'your-regular-token-here' or argocd_mcp_api_token == ''
        
        - name: Debug - Show token generation result
          ansible.builtin.debug:
            msg: "Token generation: rc={{ generated_token.rc | default('skipped') }}, stdout_lines={{ generated_token.stdout_lines | default([]) | length }}, stderr={{ generated_token.stderr | default('none') }}"
          when: generated_token is defined

        - name: Set token variable
          ansible.builtin.set_fact:
            argocd_mcp_api_token: "{{ generated_token.stdout | trim }}"
          when: generated_token is defined and generated_token.stdout is defined and generated_token.stdout | trim != ''

        - name: Debug - Show final token info
          ansible.builtin.debug:
            msg: "Final token length: {{ argocd_mcp_api_token | length }}, starts with: {{ argocd_mcp_api_token[:20] if argocd_mcp_api_token | length > 20 else argocd_mcp_api_token }}"
          when: argocd_mcp_api_token is defined and argocd_mcp_api_token != ''
      when: argocd_mcp_issue_token_enabled | default(false) and argocd_cli_check.rc == 0

    - name: Warn if token generation was requested but CLI not available
      ansible.builtin.debug:
        msg: "WARNING: argocd_mcp_issue_token_enabled is true but argocd CLI is not available. Using token from variables."
      when: argocd_mcp_issue_token_enabled | default(false) and argocd_cli_check.rc != 0

    - name: Ensure Cursor config directory exists
      ansible.builtin.file:
        path: "{{ ansible_env.HOME }}/.cursor"
        state: directory
        mode: '0755'

    - name: Install Cursor MCP configuration
      ansible.builtin.template:
        src: "{{ playbook_dir }}/templates/cursor.mcp.json.j2"
        dest: "{{ ansible_env.HOME }}/.cursor/mcp.json"
        mode: '0644'

